(()=>{"use strict";let e=e=>e.match(/^[A-Z]+\d+$/)?{type:"reference",value:e}:e.length>0&&!isNaN(Number(e))?{type:"literal",value:Number(e)}:{type:"unknown",value:e},t=t=>{let r=Object.entries(t).map(t=>{let[r,n]=t;return[r,(t=>{let r=[...t.matchAll(/(\+|-|\*|\/|$)/g)].map(e=>{let{index:t}=e;return t});return r.reduce((n,a,l)=>{let s;return 0===l?[...n,e(t.slice(0,a).trim())]:[...n.slice(0,-1),(s=t[r[l-1]],{type:"operator",name:s,left:n.at(-1),right:e(t.slice(r[l-1]+1,a).trim())})]},[])[0]})(n)]}),n=e=>"operator"===e.type?[...n(e.left),...n(e.right)]:"reference"===e.type?[e.value]:[],a=r.flatMap(e=>{let[t,r]=e;return n(r).map(e=>({source:e,target:t}))});return{dependents:Object.fromEntries(Object.entries(Object.groupBy(a,e=>{let{source:t}=e;return t})).map(e=>{let[t,r]=e;return[t,r.map(e=>{let{target:t}=e;return t})]})),dependencies:Object.fromEntries(Object.entries(Object.groupBy(a,e=>{let{target:t}=e;return t})).map(e=>{let[t,r]=e;return[t,r.map(e=>{let{source:t}=e;return t})]})),table:Object.fromEntries(r)}},r=e=>{var t;let{alpha:r,numeric:n}=(null==(t=e.match(/^(?<alpha>[A-Z]+)(?<numeric>\d+)$/))?void 0:t.groups)??{};if(void 0!==r&&void 0!==n)return[r.charCodeAt(0)-65,Number(n)-1]},n=(e,t)=>{let n=r(t);if(void 0!==n){let[t,r]=n;if(t>=0&&t<e.width&&!Number.isNaN(r)&&r>=0&&r<e.height)return r*e.width+t}return -1},a=(e,t,r)=>{let a=e.table[r],l=n(t,r),s=e=>{switch(e.type){case"reference":return t.data[n(t,e.value)];case"operator":{let t=s(e.left),r=s(e.right);switch(e.name){case"+":return t+r;case"-":return t-r;case"*":return t*r;case"/":return t/r;default:throw e.name,Error("This should never happen!")}}case"literal":return e.value;case"unknown":return NaN}},i=s(a);return t.data[l]=i,i},l=Array.from({length:20},(e,t)=>[`${t+1}`,...Array.from({length:12},()=>"")]),s={width:12,height:20,data:new Float32Array(240)},i={},c=t({}),d=[];self.onconnect=e=>{let n=e.ports[0];d.push(n),n.postMessage({type:2,parsedExpressions:c.table,rawExpressions:i,rowData:l}),n.addEventListener("message",e=>{if(1===e.data.type){console.log("UPDATE EVENT",e.data);let n=e.data.expressions,o=t(n);for(let[e,t]of(i={...i,...n},function*(e,t,r){let n=r;for(;n.length>0;){for(let r of n)yield[r,a(e,t,r)];n=n.flatMap(t=>e.dependents[t]??[])}}(c=((e,t)=>{let r={...e.dependents};return Object.entries(t.dependencies).forEach(t=>{let[n,a]=t;n in e.dependencies||(e.dependencies[n]=a),e.dependencies[n].forEach(e=>{if(!a.includes(e)){let t=r[e];t.splice(t.indexOf(n),1),0===t.length&&delete r[e]}}),a.forEach(e=>{e in r||(r[e]=[n]),r[e].includes(n)||r[e].push(n)})}),Object.entries(t.dependents).forEach(e=>{let[t,n]=e;t in r||(r[t]=n)}),{dependents:r,dependencies:{...e.dependencies,...t.dependencies},table:{...e.table,...t.table}}})(c,o),s,Object.keys(n)))){let n=r(e);if(void 0!==n){let[e,r]=n;l[r][e+1]=`${t}`}}let p={type:2,parsedExpressions:c.table,rawExpressions:i,rowData:l};d.forEach(e=>{try{e.postMessage(p)}catch(t){console.error("Posting update error:",t),d.splice(d.indexOf(e),1)}})}}),n.start()}})();